# =====================================================
# APACHE VIRTUAL HOST CONFIGURATION
# AdabKita - Platform Pembelajaran Adab Islami
# =====================================================
#
# INSTALASI:
# 1. Copy file ini ke /etc/apache2/sites-available/
#    sudo cp apache-adabkita.conf /etc/apache2/sites-available/
#
# 2. Edit domain dan path sesuai kebutuhan
#
# 3. Enable site:
#    sudo a2ensite apache-adabkita.conf
#
# 4. Enable required modules:
#    sudo a2enmod rewrite ssl headers
#
# 5. Test configuration:
#    sudo apache2ctl configtest
#
# 6. Reload Apache:
#    sudo systemctl reload apache2
#
# =====================================================

# =====================================================
# HTTP (Port 80) - Redirect to HTTPS
# =====================================================
<VirtualHost *:80>
    ServerName adabkita.gaspul.com
    ServerAlias www.adabkita.gaspul.com

    # Redirect all HTTP traffic to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]

    # Logs
    ErrorLog ${APACHE_LOG_DIR}/adabkita-error.log
    CustomLog ${APACHE_LOG_DIR}/adabkita-access.log combined
</VirtualHost>

# =====================================================
# HTTPS (Port 443) - Main Configuration
# =====================================================
<VirtualHost *:443>
    # =====================================================
    # SERVER CONFIGURATION
    # =====================================================
    ServerName adabkita.gaspul.com
    ServerAlias www.adabkita.gaspul.com
    ServerAdmin admin@adabkita.gaspul.com

    # =====================================================
    # DOCUMENT ROOT - PENTING: Harus ke folder /public
    # =====================================================
    DocumentRoot /var/www/adabkita/public

    <Directory /var/www/adabkita/public>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted

        # Laravel Pretty URLs
        <IfModule mod_rewrite.c>
            RewriteEngine On

            # Handle Authorization Header
            RewriteCond %{HTTP:Authorization} .
            RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]

            # Redirect Trailing Slashes
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteCond %{REQUEST_URI} (.+)/$
            RewriteRule ^ %1 [L,R=301]

            # Handle Front Controller
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteRule ^ index.php [L]
        </IfModule>
    </Directory>

    # =====================================================
    # SECURITY HEADERS
    # =====================================================
    <IfModule mod_headers.c>
        # Prevent clickjacking
        Header always set X-Frame-Options "SAMEORIGIN"

        # Prevent MIME sniffing
        Header always set X-Content-Type-Options "nosniff"

        # Enable XSS Protection
        Header always set X-XSS-Protection "1; mode=block"

        # Referrer Policy
        Header always set Referrer-Policy "strict-origin-when-cross-origin"

        # Content Security Policy (sesuaikan dengan kebutuhan)
        # Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self';"

        # Remove Server signature
        Header unset Server
        Header always unset X-Powered-By
    </IfModule>

    # =====================================================
    # PHP CONFIGURATION
    # =====================================================
    <IfModule mod_php.c>
        php_value upload_max_filesize 50M
        php_value post_max_size 50M
        php_value memory_limit 256M
        php_value max_execution_time 300
        php_value max_input_time 300
    </IfModule>

    # =====================================================
    # FILE ACCESS RESTRICTIONS
    # =====================================================

    # Deny access to .env file
    <Files ".env">
        Require all denied
    </Files>

    # Deny access to hidden files
    <FilesMatch "^\.">
        Require all denied
    </FilesMatch>

    # Deny access to specific directories
    <DirectoryMatch "^/var/www/adabkita/(\.git|storage|bootstrap|database|config|routes|tests|resources/views)">
        Require all denied
    </DirectoryMatch>

    # Allow access to storage/app/public only (for uploaded files)
    Alias /storage /var/www/adabkita/storage/app/public
    <Directory /var/www/adabkita/storage/app/public>
        Options -Indexes
        AllowOverride None
        Require all granted
    </Directory>

    # =====================================================
    # SSL CONFIGURATION (Let's Encrypt)
    # =====================================================
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/adabkita.gaspul.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/adabkita.gaspul.com/privkey.pem

    # Modern SSL Configuration
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder off
    SSLSessionTickets off

    # OCSP Stapling
    SSLUseStapling on
    SSLStaplingResponderTimeout 5
    SSLStaplingReturnResponderErrors off

    # HTTP Strict Transport Security (HSTS)
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

    # =====================================================
    # COMPRESSION (GZIP)
    # =====================================================
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json application/xml
    </IfModule>

    # =====================================================
    # CACHING
    # =====================================================
    <IfModule mod_expires.c>
        ExpiresActive On

        # Images
        ExpiresByType image/jpeg "access plus 1 year"
        ExpiresByType image/png "access plus 1 year"
        ExpiresByType image/gif "access plus 1 year"
        ExpiresByType image/svg+xml "access plus 1 year"
        ExpiresByType image/x-icon "access plus 1 year"

        # CSS and JavaScript
        ExpiresByType text/css "access plus 1 month"
        ExpiresByType application/javascript "access plus 1 month"

        # Fonts
        ExpiresByType font/woff "access plus 1 year"
        ExpiresByType font/woff2 "access plus 1 year"
        ExpiresByType application/font-woff "access plus 1 year"
        ExpiresByType application/font-woff2 "access plus 1 year"

        # PDF
        ExpiresByType application/pdf "access plus 1 month"
    </IfModule>

    # =====================================================
    # ERROR DOCUMENTS
    # =====================================================
    ErrorDocument 404 /index.php
    ErrorDocument 403 /index.php
    ErrorDocument 500 /index.php

    # =====================================================
    # LOGGING
    # =====================================================
    ErrorLog ${APACHE_LOG_DIR}/adabkita-ssl-error.log
    CustomLog ${APACHE_LOG_DIR}/adabkita-ssl-access.log combined

    # Log level (production: warn, development: debug)
    LogLevel warn

</VirtualHost>

# =====================================================
# GLOBAL SSL CONFIGURATION
# =====================================================
<IfModule mod_ssl.c>
    SSLStaplingCache "shmcb:logs/ssl_stapling(32768)"
</IfModule>

# =====================================================
# NOTES:
# =====================================================
# 1. Ganti "adabkita.gaspul.com" dengan domain Anda
# 2. Ganti "/var/www/adabkita" dengan path aplikasi Anda
# 3. Jalankan certbot untuk generate SSL certificate:
#    sudo certbot --apache -d adabkita.gaspul.com -d www.adabkita.gaspul.com
# 4. Test SSL: https://www.ssllabs.com/ssltest/
# 5. Auto-renewal SSL sudah di-handle oleh certbot
#
# Monitoring:
# - Access log: tail -f /var/log/apache2/adabkita-ssl-access.log
# - Error log: tail -f /var/log/apache2/adabkita-ssl-error.log
#
# =====================================================
